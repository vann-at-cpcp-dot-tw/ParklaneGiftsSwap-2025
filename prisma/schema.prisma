// Prisma Schema for Gift Exchange Game

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 格子表：30 個固定格子
model Grid {
  id                   Int          @id @default(autoincrement())
  gridNumber           Int          @unique // 1-30
  currentGiftType      String?      // 'A' | 'B' | 'C' | 'default'
  currentParticipantId Int?         // 當前格子內禮物的擁有者 ID
  status               String       @default("available") // 'available' | 'locked'
  updatedAt            DateTime     @updatedAt

  submissions          Submission[]

  @@index([status])
  @@index([currentGiftType, status])
}

// 提交表：參加者記錄
model Submission {
  id                Int       @id @default(autoincrement())
  participantNumber Int       // 全局參加者編號（包含預設禮物）
  isInitialGift     Boolean   @default(false) // 是否為預設禮物（初始化時的 30 個禮物）
  realParticipantNo Int?      // 真實參加者編號（1, 2, 3...，預設禮物為 null）
  giftType          String    // 'A' | 'B' | 'C'
  message           String    @default("") // 20 字留言

  // 聯絡資訊
  name              String    @default("") // 姓名
  lineId            String?   // LINE ID（可選）
  instagram         String?   // Instagram（可選）

  assignedGridId    Int       // 抽到哪一格
  status            String    @default("pending") // 'pending' | 'completed'
  createdAt         DateTime  @default(now())
  completedAt       DateTime?
  expiresAt         DateTime? // 超時時間（5 分鐘，可選）

  // 軟刪除
  isDeleted         Boolean   @default(false) // 是否已刪除
  deletedAt         DateTime? // 刪除時間

  grid              Grid      @relation(fields: [assignedGridId], references: [id])

  @@index([assignedGridId])
  @@index([status])
  @@index([expiresAt])
  @@index([isInitialGift])
  @@index([realParticipantNo])
  @@index([isDeleted])                              // 優化軟刪除過濾
  @@index([participantNumber])                      // 優化查詢最後一個參加者編號
  @@index([assignedGridId, status, completedAt])    // 優化查詢特定格子的最新完成記錄
  @@index([isInitialGift, realParticipantNo])       // 優化查詢下一個真實參加者編號
  @@index([assignedGridId, status, completedAt, isDeleted]) // 優化查詢特定格子的最新未刪除記錄
}
